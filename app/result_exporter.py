"""
Export Module for RAG System.
Exports answers and sources as Markdown or PDF.
"""

import os
import logging
from datetime import datetime
from typing import Dict, Any, List, Optional
from pathlib import Path
import json

logger = logging.getLogger(__name__)


class ResultExporter:
    """Exports RAG results to various formats."""
    
    def __init__(self, export_dir: str = "./data/exports"):
        """
        Initialize the result exporter.
        
        Args:
            export_dir: Directory to save exported files
        """
        self.export_dir = Path(export_dir)
        self.export_dir.mkdir(parents=True, exist_ok=True)
    
    def _sanitize_filename(self, text: str, max_length: int = 50) -> str:
        """Create a safe filename from text."""
        # Remove special characters
        safe_text = "".join(c if c.isalnum() or c in " -_" else "_" for c in text)
        # Remove multiple spaces/underscores
        safe_text = "_".join(safe_text.split())
        # Truncate
        if len(safe_text) > max_length:
            safe_text = safe_text[:max_length]
        return safe_text.strip("_")
    
    def export_to_markdown(
        self,
        query: str,
        answer: str,
        sources: List[Dict[str, Any]],
        metadata: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        Export results to Markdown format.
        
        Args:
            query: The original query
            answer: The generated answer
            sources: List of source documents
            metadata: Optional metadata
            
        Returns:
            Markdown content as string
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        md_lines = [
            "# RAG Query Results",
            "",
            f"**Generated:** {timestamp}",
            "",
            "---",
            "",
            "## Question",
            "",
            f"> {query}",
            "",
            "## Answer",
            "",
            answer,
            "",
        ]
        
        if sources:
            md_lines.extend([
                "---",
                "",
                "## Sources",
                "",
            ])
            
            for i, source in enumerate(sources, 1):
                file_name = source.get("file_name", "Unknown")
                page = source.get("page", "N/A")
                score = source.get("score", 0)
                text = source.get("text", "")
                
                # Clean up filename for display
                display_name = file_name.replace(".pdf", "").replace("_", " ")
                
                md_lines.extend([
                    f"### Source {i}: {display_name}",
                    "",
                    f"- **Page:** {page}",
                    f"- **Relevance Score:** {score*100:.1f}%",
                    "",
                    "```",
                    text.strip(),
                    "```",
                    "",
                ])
        
        if metadata:
            md_lines.extend([
                "---",
                "",
                "## Metadata",
                "",
            ])
            
            for key, value in metadata.items():
                if key not in ("query", "sources"):  # Skip duplicate info
                    if isinstance(value, dict):
                        md_lines.append(f"- **{key}:** `{json.dumps(value)}`")
                    elif isinstance(value, list):
                        md_lines.append(f"- **{key}:** {', '.join(str(v) for v in value)}")
                    else:
                        md_lines.append(f"- **{key}:** {value}")
            
            md_lines.append("")
        
        md_lines.extend([
            "---",
            "",
            "*Generated by Local RAG System*",
        ])
        
        return "\n".join(md_lines)
    
    def export_to_json(
        self,
        query: str,
        answer: str,
        sources: List[Dict[str, Any]],
        metadata: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        Export results to JSON format.
        
        Args:
            query: The original query
            answer: The generated answer
            sources: List of source documents
            metadata: Optional metadata
            
        Returns:
            JSON content as string
        """
        export_data = {
            "timestamp": datetime.now().isoformat(),
            "query": query,
            "answer": answer,
            "sources": sources,
            "metadata": metadata or {},
        }
        
        return json.dumps(export_data, indent=2, ensure_ascii=False)
    
    def export_to_html(
        self,
        query: str,
        answer: str,
        sources: List[Dict[str, Any]],
        metadata: Optional[Dict[str, Any]] = None
    ) -> str:
        """
        Export results to a standalone HTML file.
        
        Args:
            query: The original query
            answer: The generated answer
            sources: List of source documents
            metadata: Optional metadata
            
        Returns:
            HTML content as string
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        # Build sources HTML
        sources_html = ""
        if sources:
            for i, source in enumerate(sources, 1):
                file_name = source.get("file_name", "Unknown")
                page = source.get("page", "N/A")
                score = source.get("score", 0)
                text = source.get("text", "")
                display_name = file_name.replace(".pdf", "").replace("_", " ")
                
                sources_html += f"""
                <div class="source">
                    <div class="source-header">
                        <span class="source-title">üìÑ Source {i}: {display_name}</span>
                        <span class="source-meta">Page {page} ‚Ä¢ {score*100:.1f}% match</span>
                    </div>
                    <div class="source-text">{text}</div>
                </div>
                """
        
        html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Results - {query[:50]}...</title>
    <style>
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f5f5f5;
        }}
        .header {{
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }}
        .header h1 {{ font-size: 1.8em; margin-bottom: 10px; }}
        .timestamp {{ opacity: 0.8; font-size: 0.9em; }}
        .question {{
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }}
        .question h2 {{ color: #667eea; margin-bottom: 10px; font-size: 1.2em; }}
        .question blockquote {{
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }}
        .answer {{
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }}
        .answer h2 {{ color: #667eea; margin-bottom: 15px; font-size: 1.2em; }}
        .answer-content {{
            white-space: pre-wrap;
            line-height: 1.8;
        }}
        .sources {{
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }}
        .sources h2 {{ color: #667eea; margin-bottom: 20px; font-size: 1.2em; }}
        .source {{
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }}
        .source-header {{
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }}
        .source-title {{ font-weight: 600; color: #333; }}
        .source-meta {{
            color: #667eea;
            font-size: 0.85em;
            background: #f0f4ff;
            padding: 4px 10px;
            border-radius: 15px;
        }}
        .source-text {{
            padding: 15px;
            font-size: 0.95em;
            color: #555;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }}
        .footer {{
            text-align: center;
            margin-top: 30px;
            color: #888;
            font-size: 0.9em;
        }}
        @media print {{
            body {{ background: white; }}
            .header {{ break-inside: avoid; }}
            .source {{ break-inside: avoid; }}
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>üîÆ RAG Query Results</h1>
        <div class="timestamp">Generated: {timestamp}</div>
    </div>
    
    <div class="question">
        <h2>‚ùì Question</h2>
        <blockquote>{query}</blockquote>
    </div>
    
    <div class="answer">
        <h2>üí° Answer</h2>
        <div class="answer-content">{answer}</div>
    </div>
    
    <div class="sources">
        <h2>üìö Sources ({len(sources)})</h2>
        {sources_html}
    </div>
    
    <div class="footer">
        Generated by Local RAG System
    </div>
</body>
</html>"""
        
        return html
    
    def save_export(
        self,
        content: str,
        format: str,
        query: str
    ) -> str:
        """
        Save exported content to a file.
        
        Args:
            content: The content to save
            format: File format (md, json, html)
            query: Original query (for filename)
            
        Returns:
            Path to saved file
        """
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        safe_query = self._sanitize_filename(query)
        filename = f"rag_export_{timestamp}_{safe_query}.{format}"
        
        filepath = self.export_dir / filename
        
        with open(filepath, "w", encoding="utf-8") as f:
            f.write(content)
        
        logger.info(f"Exported results to: {filepath}")
        return str(filepath)


# Singleton instance
_exporter = None


def get_result_exporter() -> ResultExporter:
    """Get the singleton result exporter instance."""
    global _exporter
    if _exporter is None:
        _exporter = ResultExporter()
    return _exporter
